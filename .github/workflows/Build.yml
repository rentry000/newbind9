name: Build BIND9 9.21.17 for arm64

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 3 * * *'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          set -e
          sudo apt update -qq
          sudo apt install -yqq --no-install-recommends \
            build-essential autoconf automake libtool pkg-config \
            libssl-dev libjson-c-dev liburcu-dev libxml2-dev \
            libjemalloc-dev liblmdb-dev libnghttp2-dev zlib1g-dev \
            bison flex python3-ply wget xz-utils ca-certificates

      - name: Download BIND 9.21.17 source from ftp.isc.org
        run: |
          set -e

          VERSION="9.21.17"
          SRC_FILE="bind-${VERSION}.tar.xz"
          URL="https://ftp.isc.org/isc/bind9/\( {VERSION}/ \){SRC_FILE}"

          echo "Version  : ${VERSION}"
          echo "File     : ${SRC_FILE}"
          echo "Full URL : ${URL}"

          wget -q --tries=3 --timeout=30 -O "\( {SRC_FILE}" " \){URL}"

          if [ \( ? -ne 0 ] || [ ! -s " \){SRC_FILE}" ]; then
            echo "ERROR: Download failed or file is empty!"
            echo "Current directory contents:"
            ls -lh . || true
            echo "Trying to list remote directory:"
            curl -s --fail "https://ftp.isc.org/isc/bind9/${VERSION}/" || echo "curl directory listing failed"
            exit 1
          fi

          echo "Download OK. File info:"
          ls -lh "${SRC_FILE}"
          file "${SRC_FILE}" || true

      - name: Extract source
        run: |
          set -e
          SRC_FILE="bind-9.21.17.tar.xz"
          echo "Extracting ${SRC_FILE} ..."
          tar xf "${SRC_FILE}"
          mv "bind-9.21.17" bind9-source || {
            echo "ERROR: Extraction or rename failed!"
            ls -l . || true
            exit 1
          }
          ls -ld bind9-source

      - name: Configure && Compile BIND9
        working-directory: ./bind9-source
        run: |
          set -e
          echo "Running autoreconf..."
          autoreconf -fi

          echo "Running configure..."
          ./configure \
            --prefix=/usr/local/bind9 \
            --with-openssl=yes \
            --with-libjson=yes \
            --with-libxml2=yes \
            --with-liburcu=yes \
            --with-jemalloc=yes \
            --with-lmdb=yes \
            --enable-full-report \
            --disable-linux-caps \
            --disable-threads \
            CFLAGS="-O2 -pipe -fPIC" \
            LDFLAGS="-static-libgcc -static-libstdc++" 2>&1 | tee ../configure.log

          echo "Running make..."
          make -j$(nproc) V=1 2>&1 | tee ../make.log

          echo "Build finished. Checking key binaries..."
          ls -lh bin/named/named bin/dig/dig bin/rndc/rndc || true

      - name: Collect binaries to root
        run: |
          set -e
          mkdir -p artifacts

          cp -v bind9-source/bin/named/named               artifacts/named              2>/dev/null || true
          cp -v bind9-source/bin/dig/dig                   artifacts/dig                2>/dev/null || true
          cp -v bind9-source/bin/dig/host                  artifacts/host               2>/dev/null || true
          cp -v bind9-source/bin/dig/delv                  artifacts/delv               2>/dev/null || true
          cp -v bind9-source/bin/check/named-checkconf     artifacts/named-checkconf    2>/dev/null || true
          cp -v bind9-source/bin/check/named-checkzone     artifacts/named-checkzone    2>/dev/null || true
          cp -v bind9-source/bin/rndc/rndc                 artifacts/rndc               2>/dev/null || true

          ls -lh artifacts/ || true

      - name: Show binary info
        run: |
          file artifacts/* 2>/dev/null || true
          echo "ldd on named:"
          ldd artifacts/named 2>/dev/null | head -n 15 || echo "named appears mostly static"

      - name: Commit binaries to repo root
        run: |
          set -e
          if [[ -n "$(ls artifacts/ 2>/dev/null)" ]]; then
            cp -v artifacts/* ./

            git config user.name  "GitHub Actions"
            git config user.email "actions@github.com"

            git add named dig host delv named-checkconf named-checkzone rndc 2>/dev/null || true
            git status

            git commit -m "Update arm64 binaries from BIND 9.21.17 (ftp.isc.org)" || echo "No changes to commit"
            git push || echo "Push skipped (maybe no change)"
          else
            echo "ERROR: No binaries collected"
            echo "configure.log tail:"
            tail -n 30 ../configure.log || true
            echo "make.log tail:"
            tail -n 50 ../make.log || true
            exit 1
          fi
