name: Build BIND9 9.21.17 for Android arm64 (NDK static, full features)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install host dependencies
        run: |
          sudo apt update -qq
          sudo apt install -yqq --no-install-recommends \
            build-essential pkg-config meson ninja-build wget unzip git autoconf libtool bison flex \
            python3-ply python3-jinja2 python3-setuptools ca-certificates gperf gengetopt autoconf automake autopoint libtool gettext gperf gengetopt pkg-config


      - name: Download Android NDK r26d
        run: |
          NDK_VERSION="r26d"
          NDK_ZIP="android-ndk-${NDK_VERSION}-linux.zip"
          wget -q https://dl.google.com/android/repository/${NDK_ZIP}
          unzip -q ${NDK_ZIP}
          mv android-ndk-${NDK_VERSION} /opt/ndk
          echo "ANDROID_NDK=/opt/ndk" >> $GITHUB_ENV
          echo "PATH=/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH" >> $GITHUB_ENV

      - name: Create gcc symlink for OpenSSL
        run: |
          mkdir -p /opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin
          ln -sf /opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang \
                 /opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-gcc
          ln -sf /opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++ \
                 /opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-g++

      - name: Cross-compile OpenSSL 1.1.1w for Android arm64 (static)
        run: |
          git clone https://github.com/openssl/openssl.git
          cd openssl
          git checkout OpenSSL_1_1_1w

          export ANDROID_NDK_HOME=/opt/ndk
          export PATH=/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          export CC=aarch64-linux-android34-clang
          export CXX=aarch64-linux-android34-clang++
          export AR=llvm-ar
          export RANLIB=llvm-ranlib
          export STRIP=llvm-strip

          rm -rf fuzz
          ./Configure android-arm64 no-shared no-asm no-tests -static \
            --prefix=/opt/openssl-android \
            --openssldir=/opt/openssl-android/ssl \
            -D__ANDROID_API__=34

          mkdir -p fuzz
          touch fuzz/build.info

          make -j$(nproc)
          make install_sw install_ssldirs

      - name: Cross-compile libuv for Android arm64 (static)
        run: |
          git clone https://github.com/libuv/libuv.git
          cd libuv
          git checkout v1.48.0
          ./autogen.sh
          ./configure \
            --host=aarch64-linux-android \
            --prefix=/opt/libuv-android \
            CC=aarch64-linux-android34-clang \
            CXX=aarch64-linux-android34-clang++ \
            AR=llvm-ar \
            RANLIB=llvm-ranlib \
            STRIP=llvm-strip \
            --disable-shared --enable-static --with-pic
          make -j$(nproc)
          make install

      - name: Cross-compile liburcu for Android arm64 (static)
        run: |
          git clone https://git.liburcu.org/userspace-rcu.git
          cd userspace-rcu
          ./bootstrap
          ./configure \
            --host=aarch64-linux-android \
            --prefix=/opt/liburcu-android \
            CC=aarch64-linux-android34-clang \
            CXX=aarch64-linux-android34-clang++ \
            AR=llvm-ar \
            RANLIB=llvm-ranlib \
            STRIP=llvm-strip \
            --disable-shared --enable-static --with-pic
          make -j$(nproc)
          make install

      - name: Cross-compile libnghttp2 for Android arm64 (static)
        run: |
          git clone https://github.com/nghttp2/nghttp2.git
          cd nghttp2
          git checkout v1.62.1
          autoreconf -fi
          ./configure \
            --host=aarch64-linux-android \
            --prefix=/opt/libnghttp2-android \
            CC=aarch64-linux-android34-clang \
            CXX=aarch64-linux-android34-clang++ \
            AR=llvm-ar \
            RANLIB=llvm-ranlib \
            STRIP=llvm-strip \
            --disable-shared --enable-static --with-pic \
            --without-libxml2 --without-libexpat --without-libcares --without-jemalloc
          make -j$(nproc)
          make install
          
      - name: Cross-compile json-c with CMake (recommended way)
        run: |
          git clone https://github.com/json-c/json-c.git
          cd json-c

          mkdir build-android && cd build-android

          cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-28 \
          -DANDROID_STL=none \
          -DBUILD_SHARED_LIBS=OFF \
          -DBUILD_STATIC_LIBS=ON \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/opt/json-c-android

          make -j$(nproc)
          make install

          ls -l /opt/json-c-android/lib/libjson-c.a

      - name: Cross-compile libxml2 for Android arm64 (static)
        run: |
          git clone https://gitlab.gnome.org/GNOME/libxml2.git
          cd libxml2
          git checkout v2.12.7
          ./autogen.sh \
            --host=aarch64-linux-android \
            --prefix=/opt/libxml2-android \
            CC=aarch64-linux-android34-clang \
            CXX=aarch64-linux-android34-clang++ \
            AR=llvm-ar \
            RANLIB=llvm-ranlib \
            STRIP=llvm-strip \
            --disable-shared --enable-static --with-pic \
            --without-python --without-lzma --without-zlib
          make -j$(nproc)
          make install

      - name: Cross-compile libcap for Android arm64 (static)
        run: |
          git clone https://git.kernel.org/pub/scm/libs/libcap/libcap.git
          cd libcap
          git checkout libcap-2.69

          # === 彻底清理所有 shared 相关规则（避免 cap_magic.o / libcap.so）===
          sed -i '/libcap\.so/d' libcap/Makefile
          sed -i '/libpsx\.so/d' libcap/Makefile
          sed -i '/capso\.o/d' libcap/Makefile
          sed -i '/cap_magic\.o/d' libcap/Makefile
          sed -i '/loader\.txt/d' libcap/Makefile
          sed -i 's/ libcap\.so//g' libcap/Makefile
          sed -i 's/ libpsx\.so//g' libcap/Makefile

          # 关键变量：让 Makefile 完全跳过共享库构建
          make -C libcap \
          CC=aarch64-linux-android34-clang \
          AR=llvm-ar \
          RANLIB=llvm-ranlib \
          STRIP=llvm-strip \
          BUILD_CC=gcc \
          prefix=/opt/libcap-android \
          lib=lib \
          SHARED=no \
          CFLAGS="-fPIC -O2 -Dlinux -D_LARGEFILE64_SOURCE -D_FILE_OFFSET_BITS=64" \
          -j$(nproc)

          # 单独执行 install（只安装静态库）
          make -C libcap \
          prefix=/opt/libcap-android \
          lib=lib \
          SHARED=no \
          install

          # 验证结果
          echo "=== 安装结果 ==="
          ls -l /opt/libcap-android/lib/libcap.a
          ls -l /opt/libcap-android/include/sys/capability.h || true
          find /opt/libcap-android -name "*.a" | head -5
      - name: Cross-compile libidn2 for Android arm64 (static) - use release tarball
        run: |
         # 下载官方 release（当前最新是 2.3.8，建议去 https://ftp.gnu.org/gnu/libidn/ 确认最新版）
         wget https://ftp.gnu.org/gnu/libidn/libidn2-2.3.8.tar.gz
         tar -xzf libidn2-2.3.8.tar.gz
         cd libidn2-2.3.8

         # 设置 NDK PATH（假设你的 NDK 在 /opt/ndk）
         export PATH=/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH

         ./configure \
          --host=aarch64-linux-android \
          --prefix=/opt/libidn2-android \
          --disable-shared \
          --enable-static \
          --with-pic \
          CC=aarch64-linux-android34-clang \
          CXX=aarch64-linux-android34-clang++ \
          AR=llvm-ar \
          RANLIB=llvm-ranlib \
          STRIP=llvm-strip \
          CFLAGS="--target=aarch64-linux-android34 -fPIC -O2" \
          LDFLAGS="--target=aarch64-linux-android34" \
           --disable-tests --disable-doc  # 加速 + 避免文档依赖

          make -j$(nproc)
          make install

          # 验证
          ls -lh /opt/libidn2-android/lib/libidn2.a || echo "libidn2.a missing!"
      - name: Cross-compile libmaxminddb for Android arm64 (static)
        run: |
          # 用官方 release tarball（当前最新 1.12.x 系列，2025-2026 年稳定版；建议查 https://github.com/maxmind/libmaxminddb/releases 确认最新）
          wget https://github.com/maxmind/libmaxminddb/releases/download/1.12.2/libmaxminddb-1.12.2.tar.gz
          tar -xzf libmaxminddb-1.12.2.tar.gz
          cd libmaxminddb-1.12.2

          # 设置 NDK PATH（假设你的 NDK 在 /opt/ndk）
          export PATH=/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH

          ./configure \
           --host=aarch64-linux-android \
           --prefix=/opt/libmaxminddb-android \
           --disable-shared \
           --enable-static \
           --with-pic \
           --disable-tests \               # 关键：禁用测试，避免 libtap 依赖
           CC=aarch64-linux-android34-clang \
           CXX=aarch64-linux-android34-clang++ \
           AR=llvm-ar \
           RANLIB=llvm-ranlib \
           STRIP=llvm-strip \
           CFLAGS="--target=aarch64-linux-android34 -fPIC -O2" \
           LDFLAGS="--target=aarch64-linux-android34"

           make -j$(nproc)
           make install

           # 验证静态库生成
           ls -lh /opt/libmaxminddb-android/lib/libmaxminddb.a || echo "libmaxminddb.a missing!"
           echo "Installed headers and libs:"
           find /opt/libmaxminddb-android -name "*.h" -o -name "*.a" | head -10

      - name: Download BIND 9.21.17 source
        run: |
          VERSION="9.21.17"
          SRC_FILE="bind-${VERSION}.tar.xz"
          URL="https://ftp.isc.org/isc/bind9/9.21.17/bind-9.21.17.tar.xz"
          wget -c "$URL"
          if [ ! -s "$SRC_FILE" ]; then echo "Download failed"; exit 1; fi
          tar xf "$SRC_FILE"
          mv "bind-${VERSION}" bind9-source

      - name: Create Meson cross file
        run: |
          cat > cross-arm64.ini << 'EOF'
          [binaries]
          c = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang'
          cpp = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++'
          ar = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
          pkgconfig = 'pkg-config'

          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'

          [properties]
          sys_root = '/opt/ndk/sysroot'
          pkg_config_libdir = '/opt/openssl-android/lib/pkgconfig:/opt/libuv-android/lib/pkgconfig:/opt/liburcu-android/lib/pkgconfig:/opt/libnghttp2-android/lib/pkgconfig:/opt/json-c-android/lib/pkgconfig:/opt/libxml2-android/lib/pkgconfig:/opt/libcap-android/lib/pkgconfig:/opt/libidn2-android/lib/pkgconfig:/opt/libmaxminddb-android/lib/pkgconfig'
          c_args = ['-I/opt/openssl-android/include', '-I/opt/libuv-android/include', '-I/opt/liburcu-android/include', '-I/opt/libnghttp2-android/include', '-I/opt/json-c-android/include', '-I/opt/libxml2-android/include', '-I/opt/libcap-android/include', '-I/opt/libidn2-android/include', '-I/opt/libmaxminddb-android/include']
          link_args = ['-L/opt/openssl-android/lib', '-L/opt/libuv-android/lib', '-L/opt/liburcu-android/lib', '-L/opt/libnghttp2-android/lib', '-L/opt/json-c-android/lib', '-L/opt/libxml2-android/lib', '-L/opt/libcap-android/lib', '-L/opt/libidn2-android/lib', '-L/opt/libmaxminddb-android/lib']
          EOF

      - name: Meson setup && Compile BIND
        working-directory: bind9-source
        env:
          PKG_CONFIG_PATH: /opt/openssl-android/lib/pkgconfig:/opt/libuv-android/lib/pkgconfig:/opt/liburcu-android/lib/pkgconfig:/opt/libnghttp2-android/lib/pkgconfig:/opt/json-c-android/lib/pkgconfig:/opt/libxml2-android/lib/pkgconfig:/opt/libcap-android/lib/pkgconfig:/opt/libidn2-android/lib/pkgconfig:/opt/libmaxminddb-android/lib/pkgconfig
        run: |
          meson setup ../build \
            --cross-file ../cross-arm64.ini \
            --prefix=/data/adb/bind9 \
            -Ddefault_library=static \
            -Doptimization=2 \
            -Dnamed-lto=auto \
            -Ddoh=enabled \
            -Dzlib=enabled \
            -Didn=enabled \
            -Ddnstap=auto \
            -Db_staticpic=true \
            --buildtype=release 2>&1 | tee ../meson-setup.log

          meson compile -C ../build -v 2>&1 | tee ../meson-compile.log

      - name: Collect binaries
        run: |
          mkdir -p artifacts
          find build -type f -executable \( -name named -o -name dig -o -name host -o -name delv -o -name rndc -o -name named-checkconf -o -name named-checkzone \) -exec cp {} artifacts/ \;
          ls -lh artifacts/ || true

      - name: Commit binaries
        run: |
          if ls artifacts/* >/dev/null 2>&1; then
            cp -v artifacts/* ./
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add named dig host delv named-checkconf named-checkzone rndc 2>/dev/null || true
            git commit -m "Update Android arm64 BIND 9.21.17 (NDK static, full deps)" || echo "No changes"
            git push || echo "Push skipped"
          else
            echo "No binaries found"
            exit 1
          fi
