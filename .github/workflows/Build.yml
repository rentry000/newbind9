name: Build BIND9 9.21.17 for Android arm64 (NDK static, libuv included)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install host dependencies
        run: |
          sudo apt update -qq
          sudo apt install -yqq --no-install-recommends \
            build-essential pkg-config meson ninja-build wget unzip git autoconf libtool \
            python3-ply python3-jinja2 python3-setuptools ca-certificates
      
      - name: Download Android NDK r26d
        run: |
          NDK_VERSION="r26d"
          NDK_ZIP="android-ndk-${NDK_VERSION}-linux.zip"
          wget -q https://dl.google.com/android/repository/${NDK_ZIP}
          unzip -q ${NDK_ZIP}
          mv android-ndk-${NDK_VERSION} /opt/ndk
          echo "ANDROID_NDK=/opt/ndk" >> $GITHUB_ENV
          echo "PATH=/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH" >> $GITHUB_ENV
      - name: Cross-compile OpenSSL for Android arm64 (static)
        run: |
          git clone https://github.com/openssl/openssl.git
          cd openssl
          git checkout openssl-3.3.2  # 固定 3.3.2（稳定，clang 支持较好）
 
          # 环境变量设置
          export ANDROID_NDK_HOME=/opt/ndk
          # 确保工具链路径在最前面
          export PATH=/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
    
          # 关键修改：不要设置 CROSS_COMPILE
          # export CROSS_COMPILE=aarch64-linux-android34-  # ❌ 注释或删除这一行

          # 直接指定编译器名称（注意：对于 API 21+，通常直接使用 aarch64-linux-android-clang 即可，NDK 会自动处理 API 级别）
          export CC=aarch64-linux-android-clang
          export CXX=aarch64-linux-android-clang++
          export AR=llvm-ar
          export RANLIB=llvm-ranlib
          export STRIP=llvm-strip
          export LD=ld.lld

          # 配置
          # 关键修改：去掉 -static（在参数中通常不需要，由 no-shared 和目标决定），并确保宏定义正确
          ./Configure android-arm64 no-shared \
          --prefix=/opt/openssl-android \
          --openssldir=/opt/openssl-android/ssl \
          -D__ANDROID_API__=34

          make -j$(nproc)
          make install_sw install_ssldirs

          # 调试输出
          ls -l /opt/openssl-android/lib/libcrypto.a /opt/openssl-android/lib/libssl.a || true

      - name: Cross-compile libuv for Android arm64 (static)
        run: |
          git clone https://github.com/libuv/libuv.git
          cd libuv
          git checkout v1.48.0 
          
          # 最新稳定版，BIND 推荐 >=1.40
          ./autogen.sh
          ./configure \
            --host=aarch64-linux-android \
            --prefix=/opt/libuv-android \
            CC=aarch64-linux-android34-clang \
            CXX=aarch64-linux-android34-clang++ \
            AR=llvm-ar \
            RANLIB=llvm-ranlib \
            STRIP=llvm-strip \
            --disable-shared --enable-static \
            --with-pic
          make -j$(nproc)
          make install

      - name: Download BIND 9.21.17 source
        run: |
          VERSION="9.21.17"
          SRC_FILE="bind-${VERSION}.tar.xz"
          URL="https://ftp.isc.org/isc/bind9/9.21.17/bind-9.21.17.tar.xz"
          wget -c "$URL"
          if [ ! -s "$SRC_FILE" ]; then echo "Download failed"; exit 1; fi
          tar xf "$SRC_FILE"
          mv "bind-${VERSION}" bind9-source

      - name: Create Meson cross file for Android arm64
        run: |
          cat > cross-arm64.ini << 'EOF'
          [binaries]
          c = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang'
          cpp = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++'
          ar = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
          pkgconfig = 'pkg-config'

          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'

          [properties]
          sys_root = '/opt/ndk/sysroot'
          c_args = ['-I/opt/ndk/sysroot/usr/include']
          cpp_args = ['-I/opt/ndk/sysroot/usr/include']
          link_args = ['-L/opt/ndk/sysroot/usr/lib/aarch64-linux-android']
          pkg_config_libdir = '/opt/ndk/sysroot/usr/lib/aarch64-linux-android/pkgconfig'
          c_args = ['-I/opt/openssl-android/include']
          link_args = ['-L/opt/openssl-android/lib']
          pkg_config_libdir = '/opt/openssl-android/lib/pkgconfig'
          EOF

      - name: Meson setup && Compile BIND
        working-directory: bind9-source
        env:
          PKG_CONFIG_PATH: /opt/libuv-android/lib/pkgconfig:/opt/openssl-android/lib/pkgconfig
        run: |
          meson setup ../build \
            --cross-file ../cross-arm64.ini \
            --prefix=/data/adb/bind9 \
            -Ddefault_library=static \
            -Doptimization=2 \
            -Dnamed-lto=auto \
            -Ddoh=enabled \
            -Dzlib=enabled \
            -Didn=enabled \
            -Ddnstap=auto \
            -Db_staticpic=true \
            --buildtype=release

          meson compile -C ../build -v

      - name: Collect binaries
        run: |
          mkdir -p artifacts
          find build -type f -executable \( -name named -o -name dig -o -name host -o -name delv -o -name rndc -o -name named-checkconf -o -name named-checkzone \) -exec cp {} artifacts/ \;
          ls -lh artifacts/

      - name: Commit binaries
        run: |
          if ls artifacts/* >/dev/null 2>&1; then
            cp -v artifacts/* ./
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add named dig host delv named-checkconf named-checkzone rndc 2>/dev/null || true
            git commit -m "Update Android arm64 BIND 9.21.17 (NDK + libuv static)" || echo "No changes"
            git push || echo "Push skipped"
          else
            exit 1
          fi
