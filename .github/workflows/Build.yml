name: Build BIND9 9.21.17 for Android arm64 (NDK static, features enabled)

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 3 * * *'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install host build dependencies
        run: |
          sudo apt update -qq
          sudo apt install -yqq --no-install-recommends \
            build-essential pkg-config meson ninja-build wget unzip \
            python3-ply python3-jinja2 python3-setuptools ca-certificates

      - name: Download Android NDK r26d
        run: |
          NDK_VERSION="r26d"
          NDK_ZIP="android-ndk-${NDK_VERSION}-linux.zip"
          wget -q https://dl.google.com/android/repository/${NDK_ZIP}
          unzip -q ${NDK_ZIP}
          mv android-ndk-${NDK_VERSION} /opt/ndk
          echo "ANDROID_NDK=/opt/ndk" >> $GITHUB_ENV

      - name: Download BIND 9.21.17 source
        run: |
          set -e
          VERSION="9.21.17"
          SRC_FILE="bind-${VERSION}.tar.xz"
          URL="https://ftp.isc.org/isc/bind9/\( {VERSION}/ \){SRC_FILE}"
          echo "Downloading from: $URL"
          wget -c https://ftp.isc.org/isc/bind9/9.21.17/bind-9.21.17.tar.xz
          if [ ! -s "$SRC_FILE" ]; then echo "Download failed"; exit 1; fi

      - name: Extract source
        run: |
          set -e
          SRC_FILE="bind-9.21.17.tar.xz"

          echo "=== 当前目录（下载后） ==="
          ls -lh .

          tar xf "$SRC_FILE"

          echo "=== 解压后目录 ==="
          ls -lh .

          if [ ! -d "bind-9.21.17" ]; then
            echo "ERROR: bind-9.21.17 目录未出现！解压失败或 tarball 有问题。"
            exit 1
          fi

          mv bind-9.21.17 bind9-source || { echo "mv 失败"; exit 1; }

          echo "=== bind9-source 检查 ==="
          ls -lh bind9-source

          if [ ! -f "bind9-source/meson.build" ]; then
            echo "ERROR: meson.build 不存在！"
            exit 1
          fi

      - name: Create Meson cross file
        run: |
          cat > cross-arm64.ini << 'EOF'
          [binaries]
          c = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang'
          cpp = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++'
          ar = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
          strip = '/opt/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
          pkgconfig = 'pkg-config'

          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'

          [properties]
          needs_exe_wrapper = true
          EOF

      - name: Meson setup && Compile
        working-directory: bind9-source
        run: |
          set -e
          pwd
          ls -l meson.build ../cross-arm64.ini || true

          meson setup ../build \
            --cross-file ../cross-arm64.ini \
            --prefix=/data/adb/bind9 \
            -Ddefault_library=static \
            -Doptimization=2 \
            -Dnamed-lto=auto \
            -Ddoh=enabled \
            -Dzlib=enabled \
            -Didn=enabled \
            -Ddnstap=auto \
            -Db_staticpic=true \
            --buildtype=release 2>&1 | tee ../meson-setup.log

          meson compile -C ../build -v 2>&1 | tee ../meson-compile.log

          echo "Built executables:"
          find ../build -type f -executable -name named -o -name dig -o -name host -o -name delv -o -name rndc -o -name named-checkconf -o -name named-checkzone 2>/dev/null || true

      - name: Collect binaries
        run: |
          mkdir -p artifacts
          find build -type f -executable \( -name named -o -name dig -o -name host -o -name delv -o -name rndc -o -name named-checkconf -o -name named-checkzone \) -exec cp {} artifacts/ \;

          ls -lh artifacts/ || true
          if [ -z "$(ls artifacts/ 2>/dev/null)" ]; then
            echo "No binaries! Check logs."
            tail -n 50 meson-setup.log
            tail -n 50 meson-compile.log
            exit 1
          fi

      - name: Binary info
        run: |
          file artifacts/* 2>/dev/null || true
          for f in artifacts/*; do echo "Deps of $f:"; readelf -d "$f" | grep NEEDED || echo "No dynamic deps"; done

      - name: Commit binaries
        run: |
          if [[ -n "$(ls artifacts/ 2>/dev/null)" ]]; then
            cp -v artifacts/* ./
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add named dig host delv named-checkconf named-checkzone rndc 2>/dev/null || true
            git commit -m "Update Android arm64 BIND 9.21.17 (NDK)" || echo "No changes"
            git push || echo "Push skipped"
          else
            exit 1
          fi
